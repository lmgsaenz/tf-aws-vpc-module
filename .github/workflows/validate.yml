name: "Validate & TFSec & Terratest"
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, reopened, synchronize]

env:
  TF_VERSION: 1.5.7
  TG_VERSION: v0.50.17
  GO_VERSION: 1.21.1
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID}}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY}}
  AWS_REGION: eu-west-1
  GITHUB_TOKEN: ${{ github.token }}
  WORKING_DIR: examples
  TERRATEST_DIR: tests

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  terraform:
    name: Terraform Validate
    runs-on: ubuntu-22.04
  
    permissions:
      contents: read
      pull-requests: write
  
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get and Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: $TF_VERSION
    
    - name: Install Terragrunt
      run: |
        curl -s -qL -o terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/$TG_VERSION/terragrunt_linux_amd64
        chmod +x terragrunt
        sudo mv terragrunt /bin
    
    - name: Terragrunt Init
      id: init
      run: terragrunt run-all init

    - name: Terragrunt format
      id: fmt
      run: terragrunt fmt -check -recursive -diff
      continue-on-error: false

    - name: Terragrunt Validate
      id: validate
      run: terragrunt run-all validate
      continue-on-error: true

    - name: Add PR Comment
      id: comment
      uses: actions/github-script@v6
      if: always() && github.ref != 'refs/heads/master'
      with:
        github-token: ${{ github.token }}
        script: |
          const output = `#### Terraform Initialization: \`${{ steps.init.outcome }}\`
          #### Terraform Format: \`${{ steps.fmt.outcome }}\`
          #### Terraform Validation: \`${{ steps.validate.outcome }}\``
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })

  test:
    name: TFSec
    needs: [terraform]
    runs-on: ubuntu-22.04

    permissions:
      contents: read
      pull-requests: write
  
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Get and Report TFSec
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          format: junit
          working_directory: ${{ env.WORKING_DIR }}
        continue-on-error: true

      - name: Post TFSec Report
        uses: aquasecurity/tfsec-pr-commenter-action@v1.2.0
        with:
          github_token: ${{ github.token }}
          tfsec_formats: junit
          soft_fail_commenter: true
  
  terratest:
    name: Terratest
    needs: [terraform]
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get and Setup go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Go Dependency
        working-directory: ${{ env.TERRATEST_DIR }}
        run: |
          go mod init ${{ github.event.repository.name }}
          go mod tidy

      - name: Run Go Tests
        id: test
        working-directory: ${{ env.TERRATEST_DIR }}
        run: go test -v
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Report back the result
        uses: actions/github-script@v6
        if: always()
        with:
          github-token: ${{ github.token }}
          script: |
            const output = `#### Terratest Result: \`${{ steps.test.conclusion }}\`
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
